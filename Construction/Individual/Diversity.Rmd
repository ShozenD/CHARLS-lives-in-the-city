---
title: "Diversity"
author: "Shozen Dan"
date: "10/2/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(haven)
```

```{r}
income.2011 <- read_dta("../../data/Household_Income_2011.dta")
income.2013 <- read_dta("../../data/Household_Income_2013.dta")
income.2015 <- read_dta("../../data/Household_Income_2015.dta")
income.2018 <- read_dta("../../data/Household_Income_2018.dta")
psu <- read_dta("../../data/PSU.dta")
```

```{r, message=FALSE}
div.2011 <- income.2011 %>% 
  select(communityID, ge004, ge006, ge007, starts_with("ge009")) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006, 0),
    ge007 = replace_na(ge007, 0),
    food_expence = 4*(ge006 + ge007)/ge004,
    ge009_1 = case_when(ge009_1 < 0 ~ 0, TRUE ~ ge009_1),
    ge009_2 = case_when(ge009_2 < 0 ~ 0, TRUE ~ ge009_2),
    ge009_3 = case_when(ge009_3 < 0 ~ 0, TRUE ~ ge009_3),
    ge009_4 = case_when(ge009_4 < 0 ~ 0, TRUE ~ ge009_4),
    ge009_5 = case_when(ge009_5 < 0 ~ 0, TRUE ~ ge009_5),
    ge009_6 = case_when(ge009_6 < 0 ~ 0, TRUE ~ ge009_6),
    ge009_7 = case_when(ge009_7 < 0 ~ 0, TRUE ~ ge009_7)
  ) %>%
  filter(food_expence != Inf) %>% 
  mutate(
    monthly_PCE = food_expence + ge009_1 + ge009_2 + ge009_3 + ge009_4 + ge009_5 + ge009_6 + ge009_7,
  ) %>% 
  group_by(communityID) %>% 
  summarise(
    median_monthly_PCE = median(monthly_PCE, na.rm=T)
  ) %>%
  select(communityID, median_monthly_PCE)

div.2013 <- income.2013 %>% 
  select(communityID, ge004, ge006, ge007, starts_with("ge009")) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006, 0),
    ge007 = replace_na(ge007, 0),
    food_expence = 4*(ge006 + ge007)/ge004,
    ge009_1 = case_when(ge009_1 < 0 ~ 0, TRUE ~ ge009_1),
    ge009_2 = case_when(ge009_2 < 0 ~ 0, TRUE ~ ge009_2),
    ge009_3 = case_when(ge009_3 < 0 ~ 0, TRUE ~ ge009_3),
    ge009_4 = case_when(ge009_4 < 0 ~ 0, TRUE ~ ge009_4),
    ge009_5 = case_when(ge009_5 < 0 ~ 0, TRUE ~ ge009_5),
    ge009_6 = case_when(ge009_6 < 0 ~ 0, TRUE ~ ge009_6),
    ge009_7 = case_when(ge009_7 < 0 ~ 0, TRUE ~ ge009_7)
  ) %>%
  filter(food_expence != Inf) %>% 
  mutate(
    monthly_PCE = food_expence + ge009_1 + ge009_2 + ge009_3 + ge009_4 + ge009_5 + ge009_6 + ge009_7,
  ) %>% 
  group_by(communityID) %>% 
  summarise(
    median_monthly_PCE = median(monthly_PCE, na.rm=T)
  ) %>%
  select(communityID, median_monthly_PCE)

div.2015 <- income.2015 %>% 
  select(communityID, ge004, ge006, ge007, starts_with("ge009")) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006, 0),
    ge007 = replace_na(ge007, 0),
    food_expence = 4*(ge006 + ge007)/ge004,
    ge009_1 = case_when(ge009_1 < 0 ~ 0, TRUE ~ ge009_1),
    ge009_2 = case_when(ge009_2 < 0 ~ 0, TRUE ~ ge009_2),
    ge009_3 = case_when(ge009_3 < 0 ~ 0, TRUE ~ ge009_3),
    ge009_4 = case_when(ge009_4 < 0 ~ 0, TRUE ~ ge009_4),
    ge009_5 = case_when(ge009_5 < 0 ~ 0, TRUE ~ ge009_5),
    ge009_6 = case_when(ge009_6 < 0 ~ 0, TRUE ~ ge009_6),
    ge009_7 = case_when(ge009_7 < 0 ~ 0, TRUE ~ ge009_7)
  ) %>%
  filter(food_expence != Inf) %>% 
  mutate(
    monthly_PCE = food_expence + ge009_1 + ge009_2 + ge009_3 + ge009_4 + ge009_5 + ge009_6 + ge009_7,
  ) %>% 
  group_by(communityID) %>% 
  summarise(
    median_monthly_PCE = median(monthly_PCE, na.rm=T)
  ) %>%
  select(communityID, median_monthly_PCE)

div.2018 <- income.2018 %>% 
  select(communityID, ge004, ge006_w4, ge007_w4, starts_with("ge009")) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006_w4, 0),
    ge007 = replace_na(ge007_w4, 0),
    food_expence = 4*(ge006_w4 + ge007_w4)/ge004,
    ge009_1 = case_when(ge009_1 < 0 ~ 0, TRUE ~ ge009_1),
    ge009_2 = case_when(ge009_2 < 0 ~ 0, TRUE ~ ge009_2),
    ge009_3 = case_when(ge009_3 < 0 ~ 0, TRUE ~ ge009_3),
    ge009_4 = case_when(ge009_4 < 0 ~ 0, TRUE ~ ge009_4),
    ge009_5 = case_when(ge009_5 < 0 ~ 0, TRUE ~ ge009_5),
    ge009_6 = case_when(ge009_6 < 0 ~ 0, TRUE ~ ge009_6),
    ge009_7 = case_when(ge009_7 < 0 ~ 0, TRUE ~ ge009_7)
  ) %>%
  filter(food_expence != Inf) %>% 
  mutate(
    monthly_PCE = food_expence + ge009_1 + ge009_2 + ge009_3 + ge009_4 + ge009_5 + ge009_6 + ge009_7,
  ) %>% 
  group_by(communityID) %>% 
  summarise(
    median_monthly_PCE = median(monthly_PCE, na.rm=T)
  ) %>%
  select(communityID, median_monthly_PCE)
```

```{r}
urban.score.div <- rbind(
  mutate(div.2011, year="2011"),
  mutate(div.2013, year="2013"),
  mutate(div.2015, year="2015"),
  mutate(div.2018, year="2018")
)

median.score <- median(urban.score.div$median_monthly_PCE, na.rm=T)
min.score <- min(urban.score.div$median_monthly_PCE, na.rm=T)
max.score <- max(urban.score.div$median_monthly_PCE, na.rm=T)

seq(from=min.score, to=median.score, length.out = 10)
seq(from=median.score, to=max.score, length.out = 11)

urban.score.div <- urban.score.div %>% 
  mutate(
    urban_score_div = case_when(
      median_monthly_PCE < 1 ~ 0,
      median_monthly_PCE < 61.11 ~ 0.5,
      median_monthly_PCE < 122.22 ~ 1,
      median_monthly_PCE < 183.33 ~ 1.5,
      median_monthly_PCE < 244.44 ~ 2,
      median_monthly_PCE < 305.56 ~ 2.5,
      median_monthly_PCE < 366.67 ~ 3,
      median_monthly_PCE < 427.78 ~ 3.5,
      median_monthly_PCE < 488.89 ~ 4,
      median_monthly_PCE < 550.0 ~ 4.5,
      median_monthly_PCE < 1130.2 ~ 5,
      median_monthly_PCE < 1710.4 ~ 5.5,
      median_monthly_PCE < 2290.6 ~ 6,
      median_monthly_PCE < 2870.8 ~ 6.5,
      median_monthly_PCE < 3451.0 ~ 7,
      median_monthly_PCE < 4031.2 ~ 7.5,
      median_monthly_PCE < 4611.4 ~ 8,
      median_monthly_PCE < 5191.6 ~ 8.5,
      median_monthly_PCE < 5771.8 ~ 9,
      median_monthly_PCE < 6352.0 ~ 9.5,
      median_monthly_PCE >= 6352.0 ~ 10,
    ) 
  ) %>% 
  select(communityID, year, urban_score_div)
```

## Data Imputation
```{r}
urban.score.div <- urban.score.div %>%
  left_join(select(psu, communityID, city_eng))

# Proxying missing data with county average
# Find communities with missing data
missing.id <- urban.score.div %>% 
  filter(is.na(urban_score_div)) %>% 
  pull(communityID)

# Computing the county average
county.avg <- urban.score.div %>% 
  group_by(city_eng) %>%
  summarise(score = mean(urban_score_div, na.rm = TRUE))

# Imputation
for(i in 1:length(missing.id)){
  city <- urban.score.div %>% 
    filter(communityID == missing.id[i]) %>% 
    pull(city_eng)
  
  proxy.score <- county.avg %>% 
    filter(city_eng == city) %>% 
    pull(score)
  
  urban.score.div[urban.score.div$communityID == missing.id[i], "urban_score_div"] <- proxy.score
}

# Checking for remaining NA
summary(urban.score.div$urban_score_div)
```


```{r}
ggplot(urban.score.div, aes(x=urban_score_div)) + 
  geom_density(aes(fill=year), alpha=0.7, adjust=2) + 
  scale_x_continuous(breaks = seq(0,10,1)) +
  labs(
    title = "CHARLS Urbanicity Index",
    subtitle = "Diversity",
    x = "Score",
    y = "Density"
  ) + 
  theme_light()
```
```{r}
write_csv(urban.score.div, "../../Scores/Individual/diversity.csv")
```

