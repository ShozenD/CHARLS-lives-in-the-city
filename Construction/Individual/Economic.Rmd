---
title: "Economic"
author: "Shozen Dan"
date: "9/29/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(haven)
```

```{r}
work.2011 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Work_Retirement_and_Pension_2011.dta")
work.2013 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Work_Retirement_and_Pension_2013.dta")
work.2015 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Work_Retirement_and_Pension_2015.dta")
work.2018 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Work_Retirement_and_Pension_2018.dta")
```

```{r}
income.2011 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Household_Income_2011.dta")
income.2013 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Household_Income_2013.dta")
income.2015 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Household_Income_2015.dta")
income.2018 <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/Household_Income_2018.dta")
```

```{r}
psu <- read_dta("~/Downloads/Stanford CARE SRI/data/diabetes/data/CHARLS/PSU.dta") %>% 
  dplyr::select(communityID,province_eng, city_eng, urban_nbs)
```


```{r}
# proportion within the community that engaged in agriculural work
mean(work.2011$fa001 == 1, na.rm = T)
mean(work.2013$fa001 == 1, na.rm = T)
mean(work.2015$fa001 == 1, na.rm = T)
mean(work.2018$fc008 == 1, na.rm = T)
```

```{r}
# average money spent on food
mean(income.2011$ge004, na.rm = T) # N of people who eat together
mean(income.2011$ge006, na.rm = T) # food expense
mean(income.2011$ge007, na.rm = T)

mean(income.2013$ge004, na.rm = T)
mean(income.2013$ge006, na.rm = T)
mean(income.2013$ge007, na.rm = T)

mean(income.2015$ge004, na.rm = T)
mean(income.2015$ge006, na.rm = T)
mean(income.2015$ge007, na.rm = T)

mean(income.2018$ge004, na.rm = T)
mean(income.2018$ge006_w4, na.rm = T)
mean(income.2018$ge007_w4, na.rm = T)
```
```{r, message=FALSE}
exp.2011 <- income.2011 %>% 
  select(communityID, ge004, ge006, ge007, ge009_1, ge009_5, ge009_7) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006, 0),
    ge007 = replace_na(ge007, 0),
    food_expence = 4*(ge006 + ge007)/ge004,
    ge009_1 = case_when(
      ge009_1 < 0 ~ 0,
      TRUE ~ ge009_1
    ),
    ge009_5 = case_when(
      ge009_5 < 0 ~ 0,
      TRUE ~ ge009_5
    ),
    ge009_7 = case_when(
      ge009_7 < 0 ~ 0,
      TRUE ~ ge009_7
    )
  ) %>%
  filter(food_expence != Inf | food_expence != -Inf) %>% 
  group_by(communityID) %>% 
  summarise(
    food = mean(food_expence, na.rm = T),
    comm = mean(ge009_1, na.rm = T),
    trans = mean(ge009_5, na.rm = T),
    ent = mean(ge009_7, na.rm = T)
  ) %>% 
  mutate(urban_score_exp = food + comm + trans + ent) %>% 
  select(communityID, urban_score_exp)

exp.2013 <- income.2013 %>% 
  select(communityID, ge004, ge006, ge007, ge009_1, ge009_5, ge009_7) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006, 0),
    ge007 = replace_na(ge007, 0),
    food_expence = 4*(ge006 + ge007)/ge004,
    ge009_1 = case_when(
      ge009_1 < 0 ~ 0,
      TRUE ~ ge009_1
    ),
    ge009_5 = case_when(
      ge009_5 < 0 ~ 0,
      TRUE ~ ge009_5
    ),
    ge009_7 = case_when(
      ge009_7 < 0 ~ 0,
      TRUE ~ ge009_7
    )
  ) %>%
  filter(food_expence != Inf | food_expence != -Inf) %>% 
  group_by(communityID) %>% 
  summarise(
    food = mean(food_expence, na.rm = T),
    comm = mean(ge009_1, na.rm = T),
    trans = mean(ge009_5, na.rm = T),
    ent = mean(ge009_7, na.rm = T)
  ) %>% 
  mutate(urban_score_exp = food + comm + trans + ent) %>% 
  select(communityID, urban_score_exp)

exp.2015 <- income.2015 %>% 
  select(communityID, ge004, ge006, ge007, ge009_1, ge009_5, ge009_7) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006 = replace_na(ge006, 0),
    ge007 = replace_na(ge007, 0),
    food_expence = 4*(ge006 + ge007)/ge004,
    ge009_1 = case_when(
      ge009_1 < 0 ~ 0,
      TRUE ~ ge009_1
    ),
    ge009_5 = case_when(
      ge009_5 < 0 ~ 0,
      TRUE ~ ge009_5
    ),
    ge009_7 = case_when(
      ge009_7 < 0 ~ 0,
      TRUE ~ ge009_7
    )
  ) %>%
  filter(food_expence != Inf | food_expence != -Inf) %>% 
  group_by(communityID) %>% 
  summarise(
    food = mean(food_expence, na.rm = T),
    comm = mean(ge009_1, na.rm = T),
    trans = mean(ge009_5, na.rm = T),
    ent = mean(ge009_7, na.rm = T)
  ) %>% 
  mutate(urban_score_exp = food + comm + trans + ent) %>% 
  select(communityID, urban_score_exp)

exp.2018 <- income.2018 %>% 
  select(communityID, ge004, ge006_w4, ge007_w4, ge009_1, ge009_5, ge009_7) %>% 
  mutate(
    ge004 = ifelse(ge004 == 0, 1, ge004),
    ge006_w4 = replace_na(ge006_w4, 0),
    ge007_w4 = replace_na(ge007_w4, 0),
    food_expence = 4*(ge006_w4 + ge007_w4)/ge004,
    ge009_1 = case_when(
      ge009_1 < 0 ~ 0,
      TRUE ~ ge009_1
    ),
    ge009_5 = case_when(
      ge009_5 < 0 ~ 0,
      TRUE ~ ge009_5
    ),
    ge009_7 = case_when(
      ge009_7 < 0 ~ 0,
      TRUE ~ ge009_7
    )
  ) %>%
  filter(food_expence != Inf | food_expence != -Inf) %>% 
  group_by(communityID) %>% 
  summarise(
    food = mean(food_expence, na.rm = T),
    comm = mean(ge009_1, na.rm = T),
    trans = mean(ge009_5, na.rm = T),
    ent = mean(ge009_7, na.rm = T)
  ) %>% 
  mutate(urban_score_exp = food + comm + trans + ent) %>% 
  select(communityID, urban_score_exp)
```

## Imputation
```{r}
summary(exp.2011$urban_score_exp)
summary(exp.2013$urban_score_exp)
summary(exp.2015$urban_score_exp)
summary(exp.2018$urban_score_exp)
```

```{r}
temp.exp <- rbind(
  mutate(exp.2011, year="2011"),
  mutate(exp.2013, year="2013"),
  mutate(exp.2015, year="2015"),
  mutate(exp.2018, year="2018")
)

ggplot(temp.exp, aes(x=log(urban_score_exp))) +
  geom_density(aes(fill=year), alpha=0.7)
```

```{r, message=FALSE}
econ.2011 <- work.2011 %>% 
  select(communityID, fa001) %>% 
  mutate(agri_work = ifelse(fa001 == 1, 1, 0)) %>% 
  group_by(communityID) %>% 
  summarise(agri_work = mean(agri_work, na.rm=T)) %>% 
  mutate(urban_score_econ = 10*(1 - agri_work))

econ.2013 <- work.2013 %>% 
  select(communityID, fa001) %>% 
  mutate(agri_work = ifelse(fa001 == 1, 1, 0)) %>% 
  group_by(communityID) %>% 
  summarise(agri_work = mean(agri_work, na.rm=T)) %>% 
  mutate(urban_score_econ = 10*(1 - agri_work))

econ.2015 <- work.2015 %>% 
  select(communityID, fa001) %>% 
  mutate(agri_work = ifelse(fa001 == 1, 1, 0)) %>% 
  group_by(communityID) %>% 
  summarise(agri_work = mean(agri_work, na.rm=T)) %>% 
  mutate(urban_score_econ = 10*(1 - agri_work))

econ.2018 <- work.2018 %>% 
  select(communityID, fc008) %>% 
  mutate(agri_work = ifelse(fc008 == 1, 1, 0)) %>% 
  group_by(communityID) %>% 
  summarise(agri_work = mean(agri_work, na.rm=T)) %>% 
  mutate(urban_score_econ = 10*(1 - agri_work))
```

## Imputation
```{r}
summary(econ.2011$urban_score_econ)
summary(econ.2013$urban_score_econ)
summary(econ.2015$urban_score_econ)
summary(econ.2018$urban_score_econ)
```

```{r}
temp.econ <- rbind(
  mutate(econ.2011, year="2011"),
  mutate(econ.2013, year="2013"),
  mutate(econ.2015, year="2015"),
  mutate(econ.2018, year="2018")
)

ggplot(temp.econ, aes(x=urban_score_econ)) + 
  geom_density(aes(fill=year), alpha=0.7)
```

```{r}
urban.score.econ <- left_join(temp.econ, temp.exp, by=c("communityID", "year")) %>% 
  mutate(urban_score_econ = (1*urban_score_econ + 2*log(urban_score_exp + 1))/3) %>% 
  select(communityID, urban_score_econ, year)

ggplot(urban.score.econ, aes(x=urban_score_econ)) + 
  geom_density(aes(fill=year), alpha=0.7) + 
  scale_x_continuous(breaks = seq(0,10,1)) +
  labs(
    title = "CHARLS Urbanicity Index",
    subtitle = "Economic",
    x = "Score",
    y = "Density"
  ) + 
  theme_light()
```
```{r}
write_csv(urban.score.econ, "score/economic.csv")
```

