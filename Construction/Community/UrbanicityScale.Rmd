---
title: "Urbanicity Scale"
author: "Shozen Dan, Nicholas Ortega"
date: "8/9/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r message=FALSE}
library(tidyverse)
library(haven)
```

```{r message=FALSE}
cohort <- read_csv("C:/Users/orteg/Downloads/cohort (3).csv")
community.2011 <- read_dta("C:/Users/orteg/Downloads/CHARLS/community2011.dta")
psu.2011 <- read_dta("C:/Users/orteg/Downloads/CHARLS/PSU.dta")
income.2011 <- read_dta("C:/Users/orteg/Downloads/Household_income_2011.dta")
house.2011 <- read_dta("C:/Users/orteg/Downloads/housing_characteristics/housing_characteristics.dta")
demo.2011 <- read_dta("C:/Users/orteg/Downloads/CHARLS/Demographic_Background2011.dta")
work.2011 <- read_dta("C:/Users/orteg/Downloads/CHARLS/Work_Retirement_and_Pension2011.dta")
community.new <- community.2011 %>% left_join(psu.2011, by="communityID")
```

```{r}
community.new <- community.new %>%
  mutate(
    urban_nbs = ifelse(urban_nbs == 0, "rural", "urban")
  )
```

### Population Density Score
```{r}
# community.2011 %>% select(ja003_1) # km^2
# community.2011 %>% select(ja003_2) # mu  1500 mu/km^2
# community.2011 %>% select(jc001) # population in 2010
community.new <- community.new %>% 
  mutate(
    pop_dense = case_when(
      ja003 == 1 ~ jc001/ja003_1,
      ja003 == 2 ~ jc001/(ja003_2/1500)
    ),
    urban_score_pop = case_when( # urbanicity score
      pop_dense < 1 ~ 0,
      pop_dense < 3 ~ 0.5,
      pop_dense < 5 ~ 1,
      pop_dense < 10 ~ 1.5,
      pop_dense < 18 ~ 2,
      pop_dense < 32 ~ 2.5,
      pop_dense < 57 ~ 3,
      pop_dense < 103 ~ 3.5,
      pop_dense < 184 ~ 4,
      pop_dense < 330 ~ 4.5,
      pop_dense < 589 ~ 5,
      pop_dense < 1053 ~ 5.5,
      pop_dense < 1881 ~ 6,
      pop_dense < 3361 ~ 6.5,
      pop_dense < 6002 ~ 7,
      pop_dense < 10721 ~ 7.5,
      pop_dense < 19148 ~ 8,
      pop_dense < 34200 ~ 8.5,
      pop_dense < 61083 ~ 9,
      pop_dense < 109097 ~ 9.5,
      pop_dense < 194852 ~ 10
    )
  )
# proxy with county level data
pop.mis.id <- community.new %>% filter(is.na(urban_score_pop)) %>% pull(communityID)
pop.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(urban_score_pop, na.rm = TRUE))
for(i in 1:length(pop.mis.id)){
  city_name <- community.new %>% filter(communityID == pop.mis.id[i]) %>% pull(city_eng)
  urban_score_pop <- pop.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == pop.mis.id[i], "urban_score_pop"] <- urban_score_pop
}
summary(community.new$urban_score_pop)
```
```{r}
ggplot(community.new, aes(x=urban_score_pop)) + 
  #geom_histogram(binwidth = 1) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7) +
  labs(
    title = "Urbanicity Scale",
    subtitle = "Distribution of Population Density Score",
    x = "Population Density Score",
    y = "Density",
    caption = "China Health and Retirement Longitudinal Survey (2010)",
    fill = "Urban NBS"
  ) + 
  theme_light()
```



### Economic Score
The CNHS Urbanicity Index looks at the male wage(CPI) and the percent of the community engaged in non-agricultural work.
```{r}
# community.2011$jd001 # The number of households engaged in non-agricultural work
# community.2011$jd007_1 # Average daily salary of male employees in local firms
# community.2011$jd007_2 # Average monthly salary of male employees in local firms
work <- work.2011 %>% 
  mutate(agri_work = ifelse(fa001 == 1, 1, 0)) %>%
  group_by(communityID) %>% 
  summarise(agri_work_prop = mean(agri_work, na.rm=TRUE))
income <- income.2011 %>% 
  group_by(communityID) %>%
  summarise(communityPCE = mean(PCE1, na.rm=TRUE))
communityPCE.median <- median(income$communityPCE, na.rm=TRUE)
econ <- left_join(work, income, by="communityID") %>% 
  mutate(
    urban_score_econ = case_when(
      communityPCE < communityPCE.median ~ (1 - agri_work_prop)*100/20,
      communityPCE >= communityPCE.median ~ 2*(1 - agri_work_prop)*100/20
    )
  )
community.new <- community.new %>% 
  left_join(econ, by="communityID")
econ.mis.id <- community.new %>% filter(is.na(urban_score_econ)) %>% pull(communityID)
econ.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(urban_score_econ, na.rm = TRUE))
for(i in 1:length(econ.mis.id)){
  city_name <- community.new %>% filter(communityID == econ.mis.id[i]) %>% pull(city_eng)
  urban_score_econ <- econ.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == econ.mis.id[i], "urban_score_econ"] <- urban_score_econ
}
ggplot(community.new, aes(x=urban_score_econ)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7) + 
  labs(
    title = "Urbanicity Scale",
    subtitle = "Distribution of Economic Score",
    x = "Economic Score",
    y = "Density",
    caption = "China Health and Retirement Longitudinal Survey (2010)",
    fill = "Urban NBS"
  ) + 
  theme_light()
```
**Problems**: Variables are only available for villages. They are not available for communities.

### Markets
Combines the traditional markets and supermarket
```{r}
#community.2011$jb028_1_11_ # number of convenience stores
#community.2011$jb028_1_12_ # number of farmers' markets
#community.2011$jb028_1_13_ # number of super markets
markets <- community.2011 %>% 
  select(
    communityID, jb028_1_11_, jb028_1_12_, jb028_1_13_, jb028_2_11_, jb028_2_12_, jb028_2_13_
  ) %>% 
  mutate_at(c(1:6), ~replace(., is.na(.), 0)) %>% # replace NAs with 0
  mutate(
    markets_1 = jb028_1_11_ + jb028_1_12_ + jb028_1_13_,
    markets_2 = case_when( # How to consider the distance to something?
      jb028_2_11_ != 0 & jb028_2_11_ < 2 ~ 0.7, 
      jb028_2_11_ != 0 & jb028_2_11_ < 5 ~ 0.5,
      jb028_2_11_ != 0 & jb028_2_11_ < 10 ~ 0.1, 
      TRUE ~ 0
    ),
    markets_3 = case_when(
      jb028_2_12_ != 0 & jb028_2_12_ < 2 ~ 0.7,
      jb028_2_12_ != 0 & jb028_2_12_ < 5 ~ 0.5,
      jb028_2_12_ != 0 & jb028_2_12_ < 10 ~ 0.1,
      TRUE ~ 0
    ),
    markets_4 = case_when(
      jb028_2_13_ != 0 & jb028_2_13_ < 2 ~ 0.7,
      jb028_2_13_ != 0 & jb028_2_13_ < 5 ~ 0.5,
      jb028_2_13_ != 0 & jb028_2_13_ < 10 ~ 0.1,
      TRUE ~ 0
    ),
    markets = (markets_1 + markets_2 + markets_3 + markets_4) * 1.1,
    urban_score_markets = case_when(
      markets <= 10 ~ markets,
      markets > 10 ~ 10
    )
  ) %>% 
  select(communityID, urban_score_markets)
community.new <- community.new %>% 
  left_join(markets, by="communityID")
ggplot(community.new, aes(x=urban_score_markets)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)
```

### Education Score
```{r}
community.new <- community.new %>% 
  mutate(
    avg_edu = (0*jc019 + 1*jc020 + 2*jc021 + 3*jc022 + 5*jc023 + 6*jc024)/100,
    urban_score_edu = avg_edu * 10/5
  )
# proxy with county level data
edu.mis.id <- community.new %>% filter(is.na(urban_score_edu)) %>% pull(communityID)
edu.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(urban_score_edu, na.rm = TRUE))
for(i in 1:length(edu.mis.id)){
  city_name <- community.new %>% filter(communityID == edu.mis.id[i]) %>% pull(city_eng)
  urban_score_edu <- edu.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == edu.mis.id[i], "urban_score_edu"] <- urban_score_edu
}
summary(community.new$urban_score_edu) # check NA
# proxy with province level data
edu.mis.id <- community.new %>% filter(is.na(urban_score_edu)) %>% pull(communityID)
edu.proxy <- community.new %>% 
  group_by(province_eng) %>%
  summarise(score = mean(urban_score_edu, na.rm = TRUE))
for(i in 1:length(edu.mis.id)){
  city_name <- community.new %>% filter(communityID == edu.mis.id[i]) %>% pull(province_eng)
  urban_score_edu <- edu.proxy %>% filter(province_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == edu.mis.id[i], "urban_score_edu"] <- urban_score_edu
}
# Data for Akesu, XingJian was not available. Need to aggregate it from individual data. 
summary(community.new$urban_score_edu) # check NA
ggplot(community.new, aes(x=urban_score_edu)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)
```
```{r}
demo.2011 <- demo.2011 %>% 
  mutate(
    edu_none = ifelse(bd001 == 1 | bd001 == 2 | bd001 == 3, 1, 0),
    edu_primary = ifelse(bd001 == 4, 1, 0),
    edu_middle = ifelse(bd001 == 5, 1, 0),
    edu_high = ifelse(bd001 == 6, 1, 0),
    edu_vocational = ifelse(bd001 == 7, 1, 0),
    edu_college = ifelse(bd001 == 8 | bd001 == 9, 1, 0),
    edu_graduate = ifelse(bd001 == 10 | bd001 == 11, 1, 0)
  )
urban_score_edu_proxy <- demo.2011 %>% 
  group_by(communityID) %>% 
  summarise(
    edu_none = mean(edu_none, na.rm = T),
    edu_primary = mean(edu_primary, na.rm = T),
    edu_middle = mean(edu_middle, na.rm = T),
    edu_high = mean(edu_high, na.rm = T),
    edu_vocational = mean(edu_vocational, na.rm = T),
    edu_college = mean(edu_college, na.rm = T),
    edu_graduate = mean(edu_graduate, na.rm = T)
  ) %>%
  mutate(
    avg_edu = (0*edu_none + 1*edu_primary + 2*edu_middle + 3*edu_high + 4*edu_vocational + 5*edu_college + 6*edu_graduate),
    urban_score_edu_indiv = 1.25 * avg_edu * 10/5 # In order to make 10 max
  ) %>% 
  select(communityID, urban_score_edu_indiv)
temp <- urban_score_edu_proxy %>% 
  left_join(psu.2011, by="communityID") %>% 
  mutate(
    urban_nbs = ifelse(urban_nbs == 1, "urban", "rural")
  )
ggplot(temp, aes(x = urban_score_edu_indiv)) + 
  geom_density(aes(fill = urban_nbs), alpha=0.7)
```
```{r}
community.new <- community.new %>%
  left_join(urban_score_edu_proxy, by="communityID")
community.new <- community.new %>% 
  mutate(
    urban_score_edu = case_when(
      !is.na(urban_score_edu) ~ (urban_score_edu + urban_score_edu_indiv)/2,
      TRUE ~ urban_score_edu_indiv
    )
  )
ggplot(community.new, aes(x=urban_score_edu)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7) + 
  labs(
    title = "Urbanicity Scale",
    subtitle = "Distribution of Education Score",
    x = "Education Score",
    y = "Density",
    caption = "China Health and Retirement Longitudinal Survey (2010)",
    fill = "Urban NBS"
  ) + 
  theme_light()
```


### Diversity
```{r}
# Educational Variance
community.new <- community.new %>% 
  mutate(
    edu_var = (
      (1 - avg_edu)^2*jc020 + 
      (2 - avg_edu)^2*jc021 + 
      (3 - avg_edu)^2*jc022 + 
      (5 - avg_edu)^2*jc023 + 
      (6 - avg_edu)^2*jc024)/100, 
    edu_var_final = case_when(
      edu_var <= 0.5 ~ 0,
      edu_var <= 0.75 ~ 1,
      edu_var <= 1 ~ 2,
      edu_var <= 1.25 ~ 3,
      edu_var <= 1.5 ~ 4,
      edu_var <= 1.75 ~ 4.5,
      edu_var <= 2.0 ~ 5,
      edu_var <= 2.25 ~ 6,
      edu_var <= 2.5 ~ 7,
      edu_var <= 2.75 ~ 8,
      edu_var <= 3 ~ 9,
      edu_var > 3 ~ 10
    )
  )
nrow(community.new)
summary(community.new$edu_var_final)
# proxy with county level data
edu_var.mis.id <- community.new %>% filter(is.na(edu_var_final)) %>% pull(communityID)
edu_var.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(edu_var_final, na.rm = TRUE))
for(i in 1:length(edu_var.mis.id)){
  city_name <- community.new %>% filter(communityID == edu_var.mis.id[i]) %>% pull(city_eng)
  edu_var_final <- edu_var.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == edu.mis.id[i], "edu_var_final"] <- edu_var_final
}
summary(community.new$edu_var_final) # check NA
# Income Variance
income_variance <- income.2011 %>% 
  group_by(communityID) %>%
  summarise(
    income_var = var(INCOME_PC, na.rm=T)/1000
  ) %>% 
  mutate(
    var_inc_final = case_when(
      income_var <= 20 ~ 1,
      income_var <= 90 ~ 2,
      income_var <= 400 ~ 3,
      income_var <= 1800 ~ 4,
      income_var <= 8100 ~ 5,
      income_var <= 36300 ~ 6,
      income_var <= 162750 ~ 7,
      income_var <= 729400 ~ 8,
      income_var <= 3269000 ~ 9,
      income_var > 2369000 ~ 10
    )
  )
community.new <- community.new %>% left_join(income_variance, by="communityID")
community.new <- community.new %>% 
  mutate(
    urban_score_div = case_when(
      !is.na(edu_var_final) & !is.na(income_var) ~ (edu_var_final + var_inc_final)/2,
      is.na(edu_var_final) ~ var_inc_final,
      TRUE ~ edu_var_final
    )
  )
summary(community.new$urban_score_div)
ggplot(community.new, aes(x=urban_score_div)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7) + 
  labs(
    title = "Urbanicity Scale",
    subtitle = "Distribution of Diversity Score",
    x = "Economic Score",
    y = "Density",
    caption = "China Health and Retirement Longitudinal Survey (2010)",
    fill = "Urban NBS"
  ) + 
  theme_light()
```
### Health Infrastructure




### Transportation Score
```{r}
community.new <- community.new %>% 
  mutate(
    road_type = case_when(
      jb001 == 1 ~ 2,
      jb001 == 2 ~ 0,
      jb001 == 3 ~ 1,
      jb001 == 4 ~ 2,
      jb001 == 5 ~ 0
    ),
    bus_stop = case_when(
      jb003 > 0 & jb004 == 0 ~ 2,
      jb003 > 0 & jb004 <= 5 ~ 1,
      jb003 == 0 & jb004 <= 5 ~ 1,
      jb003 == -999 & jb004 <= 5 ~ 1,
      jb003 > 0 & jb004 > 5 ~ 0,
      jb003 == 0 | is.na(jb003) | jb003 == -999 ~ 0
    ),
    train_stop = case_when(
      jb005 == 0 ~ 2,
      jb005 <= 5 ~ 1,
      TRUE ~ 0
    ),
    urban_score_trans = (road_type + bus_stop + train_stop)*1.6666
  )
### Need double checking
# What is considered close?
ggplot(community.new, aes(x=urban_score_trans)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)
```

### Housing
#### Electricity
```{r}
community.new <- community.new %>% 
  mutate(# electricity
    jb020 = case_when(
      jb020 == 24 | jb020 == 0 ~ 366, # correcting inaccurate entries
      TRUE ~ jb020
    ),
    electric_timing = (jb021/24 * jb020/366)*10 # (hours per day of electricity/24 * days per year with electricity/366)*10
  )
electricity.mis.id <- community.new %>% filter(is.na(electric_timing)) %>% pull(communityID)
electricity.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(electric_timing, na.rm = TRUE))
for(i in 1:length(electricity.mis.id)){
  city_name <- community.new %>% filter(communityID == electricity.mis.id[i]) %>% pull(city_eng)
  electricity <- electricity.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == electricity.mis.id[i], "electric_timing"] <- electricity
}
summary(community.new$electric_timing) # check for NA
```

#### Water
```{r}
community.new <- community.new %>% 
  rename(
    water_tap = jb006_1,
    water_well = jb006_2,
    water_pool = jb006_3,
    water_river_lakes = jb006_4,
    water_rain_snow = jb006_5,
    water_cellar = jb006_6,
    water_spring = jb006_7,
    water_other = jb006_8
  )
community.new <- community.new %>% 
  replace_na(
    list(
      water_tap = 0, 
      water_well = 0, 
      water_pool = 0, 
      water_river_lakes = 0, 
      water_rain_snow = 0, 
      water_cellar = 0, 
      water_spring = 0, 
      water_other = 0
    )
  ) %>%
  mutate(
    water_tap =  ifelse(water_tap == 999, 0, water_tap),
    water_well = ifelse(water_well == 999, 0, water_well),
    water_pool = ifelse(water_pool == 999, 0, water_pool),
    water_river_lakes = ifelse(water_river_lakes == 999, 0, water_river_lakes),
    water_rain_snow = ifelse(water_rain_snow == 999, 0, water_rain_snow),
    water_cellar = ifelse(water_cellar == 999, 0, water_cellar),
    water_spring = ifelse(water_spring == 999, 0, water_spring),
    water_other = ifelse(water_other == 999, 0, water_other)
  ) %>% 
  mutate( # Classify water into underground and surface water
    water_underground = water_well + water_spring,
    water_surface = water_pool + water_river_lakes + water_cellar,
  ) %>% 
  mutate(
    tap_water = water_tap/(water_tap + water_surface + water_underground) * 10
  )
# Main water type
water.mis.id <- community.new %>% filter(is.na(tap_water)) %>% pull(communityID)
water.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(tap_water, na.rm = TRUE))
for(i in 1:length(water.mis.id)){
  city_name <- community.new %>% filter(communityID == water.mis.id[i]) %>% pull(city_eng)
  water_type <- water.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == water.mis.id[i], "tap_water"] <- water_type
}
summary(community.new$tap_water) # check NA
```

#### Toilet
```{r}
inhouse_flush_toilet <- house.2011 %>% 
  left_join(select(community.2011, communityID, jb013)) %>%
  select(ID, communityID, householdID, i012_3, i013, i015, jb013) %>% 
  mutate(
    inhouse_flush_toilet = case_when(
      i012_3 > 0 & i015 == 1 ~ 1,
      i012_3 > 0 & jb013 == 1 ~ 1, # predict toilet type based on community level data
      i012_3 > 0 & is.na(i015) & jb013 != 1 ~ 0,
      i012_3 > 0 & jb013 != 1 ~ 0,
      is.na(i012_3) & i013 > 0 ~ 0,
      jb013 == 1 ~ 1,
      i012_3 == 0 ~ 0
    )
  ) %>%
  group_by(communityID) %>% 
  summarise(inhouse_flush_toilet = mean(inhouse_flush_toilet, na.rm = T) * 10)
community.new <- left_join(community.new, inhouse_flush_toilet, by="communityID")
summary(community.new$inhouse_flush_toilet) # check for NA
```

#### Gas
```{r}
community.new <- community.new %>% 
  rename(
    fuel_hay = jb007_1,
    fuel_coal = jb007_2,
    fuel_marsh_gas = jb007_3,
    fuel_natural_gas = jb007_4,
    fuel_lpg = jb007_5,
    fuel_other = jb007_6
  )
community.new <- community.new %>% 
  replace_na(
    list(
      fuel_hay = 0, 
      fuel_coal = 0, 
      fuel_marsh_gas = 0, 
      fuel_natural_gas = 0, 
      fuel_lpg = 0, 
      fuel_other = 0
    )
  ) %>%
  mutate(
    fuel_hay = ifelse(fuel_hay == 999, 0, fuel_hay),
    fuel_coal = ifelse(fuel_coal == 999, 0, fuel_coal),
    fuel_marsh_gas = ifelse(fuel_marsh_gas == 999, 0, fuel_marsh_gas),
    fuel_natural_gas = ifelse(fuel_natural_gas == 999, 0, fuel_natural_gas),
    fuel_lpg = ifelse(fuel_lpg == 999, 0, fuel_lpg),
    fuel_other = ifelse(fuel_other == 999, 0, fuel_other),
    # combine lpg and natural gas
    fuel_lpg_natural = fuel_lpg + fuel_natural_gas,
    # combine hay and marsh gas
    fuel_hay_marsh = fuel_marsh_gas + fuel_hay,
    # calculate percentage with lpg/natural gas
    cooking_fuel = fuel_lpg_natural/(fuel_lpg_natural + fuel_hay_marsh + fuel_coal + fuel_other) * 10
  )
# Main fuel type
fuel.mis.id <- community.new %>% filter(is.na(cooking_fuel)) %>% pull(communityID)
fuel.proxy <- community.new %>% 
  group_by(city_eng) %>%
  summarise(score = mean(cooking_fuel, na.rm = TRUE))
for(i in 1:length(fuel.mis.id)){
  city_name <- community.new %>% filter(communityID == fuel.mis.id[i]) %>% pull(city_eng)
  fuel_type <- fuel.proxy %>% filter(city_eng == city_name) %>% pull(score)
  community.new[community.new$communityID == fuel.mis.id[i], "cooking_fuel"] <- fuel_type
}
summary(community.new$cooking_fuel) # check for NA
```

```{r}
community.new <- community.new %>%
  mutate(urban_score_housing = (electric_timing + tap_water + inhouse_flush_toilet + cooking_fuel)/4)
ggplot(community.new, aes(x=urban_score_housing)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)
```

### Sanitation


```{r}
house.new = house.2011 %>% 
  left_join(select(community.2011, communityID, jb013)) %>%
  select(communityID, householdID, i012_3, i013, i015, jb013) %>% 
  mutate(
    inhouse_flush_toilet2 = case_when(
      i012_3 > 0 & i015 == 1 ~ 1,
      i012_3 > 0 & jb013 == 1 ~ 1, # predict toilet type based on community level data
      i012_3 > 0 & is.na(i015) & jb013 != 1 ~ 0,
      i012_3 > 0 & jb013 != 1 ~ 0,
      is.na(i012_3) & i013 > 0 ~ 0,
      jb013 == 1 ~ 1,
      i012_3 == 0 ~ 0
    )
  ) %>%
  mutate(
    excreta_absent = case_when(
      i012_3 > 0 & i015 == 1 ~ 1,
      i012_3 > 0 & i015 == 2 ~ 1, 
      i012_3 > 0 & jb013 == 1 ~ 1, 
      i012_3 > 0 & jb013 == 2 ~ 1,
      i012_3 > 0 & is.na(i015) & jb013 != 1 ~ 0,
      i012_3 > 0 & jb013 != 1 ~ 0,
      is.na(i012_3) & i013 > 0 ~ 0,
      jb013 == 1 ~ 1,
      jb013 == 2 ~ 1,
      jb013 > 2 ~ 0,
      i012_3 == 0 ~ 0
      
    )
  ) %>% 
  group_by(communityID) %>% 
  summarise(inhouse_flush_toilet2 = mean(inhouse_flush_toilet2, na.rm = T) * 10,excreta_absent = mean(excreta_absent, na.rm = T) * 10)


community.new <- left_join(community.new, house.new, by="communityID")
summary(community.new$inhouse_flush_toilet2) # check for NA
summary(community.new$excreta_absent) # check for NA

community.new=community.new %>% mutate(urban_score_sani=(inhouse_flush_toilet2+excreta_absent)/2)

ggplot(community.new, aes(x=urban_score_sani)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)

summary(community.new$urban_score_sani)

```

### Communications



```{r}
community.new=community.new %>% 
   rename(
    cinema = jb028_1_9_,
    postoffice = jb028_1_5_, 
    telephone = jb023, # proxy for telephone service
    cellphone = jb024, # cellphone
    television = jb025, # television, and proxy for news
    fridge = jb026 # refrigerator proxy for computer 
   )


community.new <- community.new %>% 
  replace_na(
    list(
      cinema = 0, 
      postoffice = 0, 
      telephone = 0, 
      cellphone = 0,
      television = 0,
      fridge = 0
    )
    
  )

community.new=community.new %>% 
  mutate(
    cinema_avail=case_when(
      cinema > 0 ~ 1,
      TRUE ~ 0 
    ),
    news_avail=case_when(
      television > 0 ~ 1,
      TRUE ~ 0
    ),
    post_avail=case_when(
      postoffice > 0 ~ 1,
      TRUE ~ 0
    ),
    teleserv_avail=case_when(
      telephone > 0 ~ 1,
      TRUE ~ 0
    )
  )

community.new=community.new %>% 
  mutate(urban_score_comm=((television/10+cellphone/10+fridge/10)/3)/(10/6)+
           cinema_avail+news_avail+post_avail+teleserv_avail)
summary(community.new$urban_score_comm)

ggplot(community.new, aes(x=urban_score_comm)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)

```

### Social Services

```{r}


community.new=community.new %>% 
   rename(
    kinder = jb028_1_1_,
    urban_insure = jf010s1, 
    rural_insure = jf010s2,
    kinder_dist= jb028_2_1_
   )


community.new <- community.new %>% 
  replace_na(
    list(
      kinder = 0, 
      urban_insure = 0, 
      rural_insure = 0,
      kinder_dist=0
  )
  )

community.new=community.new %>% 
  mutate(
    kinder_avail=case_when(
      kinder > 0 ~ 1,
      TRUE ~ 0 
    ),
    urban_avail=case_when(
      urban_insure > 0 ~ 1,
      TRUE ~ 0
    ),
    rural_avail=case_when(
      rural_insure > 0 ~ 1,
      TRUE ~ 0
    ),
    kinder_distance=case_when(
      kinder_dist > 0 & kinder_dist < 25 ~ 1,
      TRUE ~ 0
      
    )
  ) 
community.new=community.new %>% 
  mutate(urban_score_soc=3.3*kinder_avail+3.3*urban_avail+3.3*rural_avail + 1.65*kinder_distance)
summary(community.new$urban_score_soc)

ggplot(community.new, aes(x=urban_score_soc)) + 
  geom_density(aes(fill=urban_nbs), alpha=0.7)



```

### Summary
```{r}
community.new <- community.new %>% 
  mutate(urbanicity_score = urban_score_pop + urban_score_edu + urban_score_trans + urban_score_housing + urban_score_markets + urban_score_div)
ggplot(community.new, aes(x=urbanicity_score)) + 
  geom_histogram(binwidth = 2, na.rm = T) + 
  labs(
    title = "Distribution of Urbanicity Score",
    subtitle = "CHARLS 2011",
    x = "Score",
    y = "Count"
  )
```