---
title: "Urban Rural Difference Analysis"
author: "Shozen Dan"
date: "7/20/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r import library, message=FALSE}
library(tidyverse)
library(haven)
library(car)
library(survey)
library(maps)
library(ggrepel)
library(viridis)
```


```{r import data, message=FALSE}
cohort <- read_csv("./cohort.csv")
cohort.baseline <- read_csv("./cohort_baseline.csv")
cohort.waveIV <- read_csv("./cohort_waveIV.csv")

health.2011 <- read_dta("../../data/diabetes/data/CHARLS/Health_Status_and_Functioning2011.dta")
house.2011 <- read_dta("../../data/diabetes/data/CHARLS/household_roster2011.dta")
demo.2011 <- read_dta("../../data/diabetes/data/CHARLS/Demographic_Background2011.dta")
weights.2011 <- read_dta("../../data/diabetes/data/CHARLS/weight.dta")
community.2011 <- read_dta("../../data/diabetes/data/CHARLS/community.dta")
psu.2011 <- read_dta("../../data/diabetes/data/CHARLS/PSU.dta")

weights.2015 <- read_dta("../../data/diabetes/data/CHARLS/weight2015.dta")
house.2015 <- read_dta("../../data/diabetes/data/CHARLS/household_roster2011.dta")
```

```{r preprocessing}
adjust_id <- function(df){
  df %>% 
    mutate(
    householdID = str_c(householdID,"0"),
    ID = str_c(householdID, substring(ID, 10,11))
  )
}

house.2011 <- adjust_id(house.2011)
demo.2011 <- adjust_id(demo.2011)
weights.2011 <- adjust_id(weights.2011)

cohort <- cohort %>% 
  left_join(demo.2011, by=c("ID", "householdID")) %>% 
  left_join(
    select(house.2011, -ID, -communityID), 
    by="householdID"
  ) %>% 
  left_join(psu.2011, by="communityID")

cohort <- cohort %>% mutate(
  urban = ifelse(urban_nbs == 1, "Urban", "Rural")
)
```

### Urban/Rural 2011

Among people who were normal in 2011, how did living in urban or rural areas influence their diabetes status in 2015
```{r}
urbrur.normal <- cohort %>% 
  select(urban, status.2011, status.2015) %>% 
  filter(status.2011 == "Normal") %>% 
  group_by(urban, status.2015) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n/sum(n))

urbrur.normal$status.2015 <- factor(urbrur.normal$status.2015, levels = c("Normal", "Prediabetes", "Diabetes"))
urbrur.normal.count <- urbrur.normal %>% group_by(urban) %>% summarise(sum = sum(n)) %>% pull(sum)

ggplot(urbrur.normal, aes(x = status.2015, y = prop, fill = status.2015)) + 
  geom_bar(stat="identity", position = position_dodge2(), width = 0.5) + 
  geom_text(aes(label=urban), vjust=-0.5, position = position_dodge2(0.5), size=2.5) +
  geom_text(aes(label=round(prop,2)), position = position_dodge2(0.5), vjust=1.7, size=2.5) + 
  scale_fill_brewer(palette = "RdBu", direction = -1) + 
  annotate("text", x=3, y=0.47, label = str_glue("n(Rural) = {count}", count = urbrur.normal.count[1]), size = 3) + 
  annotate("text", x=3, y=0.43, label = str_glue("n(Urban) = {count}", count = urbrur.normal.count[2]), size = 3) + 
  labs(
    title = "Diabetes status of people who were healthy in 2011",
    subtitle = "Disaggregated by resident type (Rural/Urban)",
    x = "Diabetes status 2015",
    y = "Proportion(%)",
    caption = "China Health and Retirement Longitudinal Survey"
  ) + 
  theme(
    legend.title = element_blank()
  )
```

Among people who were prediabetic in 2011, how did living in urban or rural areas influence their diabetes status in 2015
```{r}
urbrur.prediabetes <- cohort %>% 
  select(urban, status.2011, status.2015) %>% 
  filter(status.2011 == "Prediabetes") %>% 
  group_by(urban, status.2015) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n/sum(n))

urbrur.prediabetes$status.2015 <- factor(urbrur.prediabetes$status.2015, levels = c("Normal", "Prediabetes", "Diabetes"))
urbrur.prediabetes.count <- urbrur.prediabetes %>% group_by(urban) %>% summarise(sum = sum(n)) %>% pull(sum)

ggplot(urbrur.prediabetes, aes(x = status.2015, y = prop, fill = status.2015)) + 
  geom_bar(stat="identity", position = position_dodge2(), width = 0.5) + 
  geom_text(aes(label=urban), vjust=-0.5, position = position_dodge2(0.5), size=2.5) +
  geom_text(aes(label=round(prop,2)), position = position_dodge2(0.5), vjust=1.7, size=2.5) + 
  scale_fill_brewer(palette = "RdBu", direction = -1) + 
  annotate("text", x=3, y=0.52, label = str_glue("n(Rural) = {count}", count = urbrur.prediabetes.count[1]), size = 3) + 
  annotate("text", x=3, y=0.48, label = str_glue("n(Urban) = {count}", count = urbrur.prediabetes.count[2]), size = 3) + 
  labs(
    title = "Diabetes status of people who were prediabetic in 2011",
    subtitle = "Disaggregated by resident type (Rural/Urban)",
    x = "Diabetes status 2015",
    y = "Proportion(%)",
    caption = "China Health and Retirement Longitudinal Survey"
  ) + 
  theme(
    legend.title = element_blank()
  )
```

### Awareness
Of the people who were aware that they had diabetes in 2011, what proportion of them got it under control in 2015? disaggregated by residence type
```{r}
urbrur.aware <- cohort %>% 
  select(urban, stage2.2011, stage3.2015) %>% 
  filter(stage2.2011 == "Aware") %>% 
  group_by(urban, stage3.2015) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n/sum(n))

urbrur.aware$stage3.2015 <- factor(urbrur.aware$stage3.2015, levels = c("Uncontrolled", "Controlled"))
urbrur.aware.count <- urbrur.aware %>% group_by(urban) %>% summarise(sum = sum(n)) %>% pull(sum)

ggplot(urbrur.aware, aes(x = stage3.2015, y = prop, fill = stage3.2015)) + 
  geom_bar(stat="identity", position = position_dodge2(), width = 0.5) + 
  geom_text(aes(label=urban), vjust=-0.5, position = position_dodge2(0.5), size=2.5) +
  geom_text(aes(label=round(prop,2)), position = position_dodge2(0.5), vjust=1.7, size=2.5) + 
  scale_fill_brewer(palette = "Paired") + 
  annotate("text", x=2.4, y=0.72, label = str_glue("n(Rural) = {count}", count = urbrur.aware.count[1]), size = 3) + 
  annotate("text", x=2.4, y=0.68, label = str_glue("n(Urban) = {count}", count = urbrur.aware.count[2]), size = 3) + 
  labs(
    title = "Diabetes control outcome in 2015 ",
    subtitle = "Among people who were aware of their diabetes in 2011, disaggregated by resident type",
    x = "Control outcome 2015",
    y = "Proportion(%)",
    caption = "China Health and Retirement Longitudinal Survey"
  ) + 
  theme(legend.title = element_blank())
```

Among people who were not aware of that they had diabetes in 2011 how many were aware in 2015?
```{r}
urbrur.unaware <- cohort %>% 
  select(urban, stage2.2011, stage2.2015) %>% 
  filter(stage2.2011 == "Unaware") %>% 
  group_by(urban, stage2.2015) %>% 
  summarise(n = n()) %>% 
  mutate(prop = n/sum(n))

urbrur.unaware$stage2.2015 <- factor(urbrur.unaware$stage2.2015, levels = c("Unaware", "Aware"))
urbrur.unaware.count <- urbrur.unaware %>% group_by(urban) %>% summarise(sum = sum(n)) %>% pull(sum)

ggplot(urbrur.unaware, aes(x = stage2.2015, y = prop, fill = stage2.2015)) + 
  geom_bar(stat="identity", position = position_dodge2(), width = 0.5) + 
  geom_text(aes(label=urban), vjust=-0.5, position = position_dodge2(0.5), size=2.5) +
  geom_text(aes(label=round(prop,2)), position = position_dodge2(0.5), vjust=1.7, size=2.5) + 
  scale_fill_brewer(palette = "Paired") + 
  annotate("text", x=2.4, y=0.82, label = str_glue("n(Rural) = {count}", count = urbrur.unaware.count[1]), size = 3) + 
  annotate("text", x=2.4, y=0.78, label = str_glue("n(Urban) = {count}", count = urbrur.unaware.count[2]), size = 3) + 
  labs(
    title = "Diabetes awareness in 2015 ",
    subtitle = "Among people who were unaware of their diabetes in 2011, disaggregated by resident type",
    x = "Control outcome 2015",
    y = "Proportion(%)",
    caption = "China Health and Retirement Longitudinal Survey"
  ) + 
  theme(legend.title = element_blank())
```
